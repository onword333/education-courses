# Подзапросы
https://youtu.be/Xt6OtcI3M4M

## Задание 2
Используя данные из таблицы user_actions, рассчитайте среднее число заказов всех пользователей нашего сервиса.

Для этого сначала в подзапросе посчитайте, сколько заказов сделал каждый пользователь, а затем обратитесь к результату подзапроса в блоке FROM и уже в основном запросе усредните количество заказов по всем пользователям.

Полученное среднее число заказов всех пользователей округлите до двух знаков после запятой. Колонку с этим значением назовите orders_avg.

Поле в результирующей таблице: orders_avg

Решение:

    SELECT
      ROUND(AVG(count_order), 2) AS orders_avg
    FROM
      (
        SELECT
          user_id,
          count(DISTINCT order_id) AS count_order
        FROM
          user_actions
        group by user_id
      ) t1

## Задание 3
Повторите запрос из предыдущего задания, но теперь вместо подзапроса используйте оператор WITH и табличное выражение.

Условия задачи те же: используя данные из таблицы user_actions, рассчитайте среднее число заказов всех пользователей.

Полученное среднее число заказов округлите до двух знаков после запятой. Колонку с этим значением назовите orders_avg.

Поле в результирующей таблице: orders_avg

Решение:

    WITH sub1 AS (
        SELECT
          user_id,
          count(DISTINCT order_id) AS count_order
        FROM
          user_actions
        GROUP BY user_id
    )
    
    SELECT
      ROUND(AVG(count_order), 2) AS orders_avg
    FROM
      sub1 t1

## Задание 4
Выведите из таблицы products информацию о всех товарах кроме самого дешёвого.

Результат отсортируйте по убыванию id товара.

Поля в результирующей таблице: product_id, name, price

Решение:

    SELECT
      product_id,
      name,
      price
    FROM
      products
    WHERE
      price <> (
        SELECT
          MIN(price)
        FROM
          products
      )
    ORDER BY
      product_id DESC

## Задание 5
Выведите информацию о товарах в таблице products, цена на которые превышает среднюю цену всех товаров на 20 рублей и более. Результат отсортируйте по убыванию id товара.

Поля в результирующей таблице: product_id, name, price

Решение:

    WITH sub1 AS (
      SELECT
        ROUND(AVG(price), 2) as avg_price
      FROM
        products
    )
    SELECT
      product_id,
      name,
      price
    FROM
      products
    WHERE
      price >= (
        SELECT
          *
        FROM
          sub1
      ) + 20
    ORDER BY
      product_id DESC

## Задание 6
Посчитайте количество уникальных клиентов в таблице user_actions, сделавших за последнюю неделю хотя бы один заказ.

Полученную колонку с числом клиентов назовите users_count. В качестве текущей даты, от которой откладывать неделю, используйте последнюю дату в той же таблице user_actions.

Поле в результирующей таблице: users_count

Решение:

    SELECT
      count(distinct user_id) as users_count
    FROM
      user_actions
    WHERE
      action = 'create_order'
      and time >= (
        SELECT
          max(time)
        FROM
          user_actions
      ) - interval '1 week'

## Задание 7
С помощью функции AGE и агрегирующей функции снова определите возраст самого молодого курьера мужского пола в таблице couriers, но в этот раз при расчётах в качестве первой даты используйте последнюю дату из таблицы courier_actions.

Чтобы получить именно дату, перед применением функции AGE переведите последнюю дату из таблицы courier_actions в формат DATE, как мы делали в этом задании.

Возраст курьера измерьте количеством лет, месяцев и дней и переведите его в тип VARCHAR. Полученную колонку со значением возраста назовите min_age.

Поле в результирующей таблице: min_age

Пояснение:

В этой задаче результат подзапроса выступает в качестве аргумента функции. Чтобы весь запрос выглядел компактнее, для приведения данных к другому типу можно использовать формат записи с двумя двоеточиями — ::.

Также обратите внимание, что для получения необходимого результата мы обращаемся к разным таблицам в рамках одного общего запроса.

Решение:

    SELECT
      min(
        age(
          (
            SELECT
              max(time) :: date
            FROM
              courier_actions
          ),
          birth_date
        )
      ) :: varchar as min_age
    FROM
      couriers
    WHERE
      sex = 'male'

## Задание 8
Из таблицы user_actions с помощью подзапроса или табличного выражения отберите все заказы, которые не были отменены пользователями.

Выведите колонку с id этих заказов. Результат запроса отсортируйте по возрастанию id заказа.

Добавьте в запрос оператор LIMIT и выведите только первые 1000 строк результирующей таблицы.

Поле в результирующей таблице: order_id

Подсказка:

Сначала в подзапросе попробуйте отобрать множество id заказов, которые были отменены. Затем уже в рамках основного запроса с помощью WHERE и IN отфильтруйте id отменённых заказов.

Решение:

    SELECT
      order_id
    FROM
      user_actions
    WHERE
      order_id NOT IN (
        SELECT
          order_id
        FROM
          user_actions
        WHERE
          action = 'cancel_order'
      )
    ORDER BY
      order_id ASC
    LIMIT
      1000
