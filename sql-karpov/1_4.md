# Фильтрация данныъ

## Задание 1
Напишите SQL-запрос к таблице products и выведите всю информацию о товарах, цена которых не превышает 100 рублей. Результат отсортируйте по возрастанию id товара.

Поля в результирующей таблице: product_id, name, price

Решение:

    SELECT product_id,
           name,
           price
    FROM   products
    WHERE  price <= 100
    ORDER BY product_id

## Задание 2
Отберите пользователей женского пола из таблицы users. Выведите только id этих пользователей. Результат отсортируйте по возрастанию id.

Добавьте в запрос оператор LIMIT и выведите только 1000 первых id из отсортированного списка.

Поле в результирующей таблице: user_id

Решение:

    SELECT
        user_id
    FROM users
    WHERE sex = 'female'
    ORDER BY
        user_id
    LIMIT 1000

## Задание 3
Отберите из таблицы user_actions все действия пользователей по созданию заказов, которые были совершены ими после полуночи 6 сентября 2022 года. Выведите колонки с id пользователей, id созданных заказов и временем их создания.

Результат должен быть отсортирован по возрастанию id заказа.

Поля в результирующей таблице: user_id, order_id, time

Решение:

    SELECT    
        user_id,
        order_id,
        time
    FROM user_actions
    WHERE CAST(time AS DATE) >= '2022-09-06 00:00:00' AND action = 'create_order'
    ORDER BY
        order_id

## Задание 4
Назначьте скидку 20% на все товары из таблицы products и отберите те, цена на которые с учётом скидки превышает 100 рублей. Выведите id товаров, их наименования, прежнюю цену и новую цену с учётом скидки. Колонку со старой ценой назовите old_price, с новой — new_price.

Результат должен быть отсортирован по возрастанию id товара.

Поля в результирующей таблице: product_id, name, old_price, new_price

Решение:

    SELECT
        price * 0.80 AS new_price,
        price AS old_price,
        product_id,
        name
    FROM products
    WHERE (price * 0.80) > 100
    ORDER BY
        product_id

## Задание 5
Отберите из таблицы products все товары, названия которых либо начинаются со слова «чай», либо состоят из пяти символов. Выведите две колонки: id товаров и их наименования.

Результат должен быть отсортирован по возрастанию id товара.

Поля в результирующей таблице: product_id, name

Решение:

    SELECT
        product_id,
        name
    FROM products
    WHERE SPLIT_PART(name, ' ', 1) = 'чай' OR LENGTH(name) = 5
    ORDER BY
        product_id

## Задание 6
Отберите из таблицы products все товары, содержащие в своём названии последовательность символов «чай» (без кавычек). Выведите две колонки: id продукта и его название.

Результат должен быть отсортирован по возрастанию id товара.

Поля в результирующей таблице: product_id, name

Решение:

    SELECT
        product_id,
        name
    FROM products
    WHERE name LIKE '%чай%'
    ORDER BY
        product_id

## Задание 7
Выберите из таблицы products id и наименования только тех товаров, названия которых начинаются на букву «с» и содержат только одно слово.

Результат должен быть отсортирован по возрастанию id товара.

Поля в результирующей таблице: product_id, name

Решение:

    SELECT
        product_id,
        name
    FROM products
    WHERE name LIKE 'с%' AND name not LIKE '% %'
    ORDER BY
        product_id

## Задание 8
Составьте SQL-запрос, который выбирает из таблицы products все чаи стоимостью больше 60 рублей и вычисляет для них цену со скидкой 25%.

Скидку в % менеджер попросил указать в отдельном столбце в формате текста, то есть вот так: «25%» (без кавычек). Столбцы со скидкой и новой ценой назовите соответственно discount и new_price.

Также необходимо любым известным способом избавиться от «чайного гриба»: вряд ли менеджер имел в виду и его, когда ставил нам задачу.

Результат должен быть отсортирован по возрастанию id товара.

Поля в результирующей таблице: product_id, name, price, discount, new_price

Решение:

    SELECT
        product_id,
        name,
        price,
        price * 0.75 AS new_price,
        '25%' AS discount
    FROM products
    WHERE 
        name LIKE '%чай%' 
        AND price > 60 
        AND name NOT LIKE '%чайный гриб%'
    ORDER BY
        product_id

## Задание 9
Из таблицы user_actions выведите всю информацию о действиях пользователей с id 170, 200 и 230 за период с 25 августа по 4 сентября 2022 года включительно. Результат отсортируйте по убыванию id заказа — то есть от самых поздних действий к самым первым.

Поля в результирующей таблице: user_id, order_id, action, time

Решение:

    SELECT 
        user_id,
        order_id,
        action,
        time
    FROM  user_actions
    WHERE user_id in(170, 200, 230)
       AND time between '2022-08-24 00:00:00'
       AND '2022-09-04 23:59:59'
    ORDER BY 
        time DESC

## Задание 10
Напишите SQL-запрос к таблице couriers и выведите всю информацию о курьерах, у которых не указан их день рождения.

Результат должен быть отсортирован по возрастанию id курьера.

Поля в результирующей таблице: birth_date, courier_id, sex

Решение:

    SELECT
        birth_date, 
        courier_id, 
        sex
    FROM couriers
    WHERE birth_date ISNULL
    ORDER BY
        courier_id

## Задание 11
Определите id и даты рождения 50 самых молодых пользователей мужского пола из таблицы users. Не учитывайте тех пользователей, у которых не указана дата рождения.

Поле в результирующей таблице: user_id, birth_date

Пояснение:

Будьте внимательны и помните про NULL значения.

Решение:

    SELECT
        user_id, 
        birth_date
    FROM users
    WHERE birth_date IS NOT NULL AND sex = 'male'
    ORDER BY
        birth_date DESC
    LIMIT 50

## Задание 12
Напишите SQL-запрос к таблице courier_actions, чтобы узнать id и время доставки последних 10 заказов, доставленных курьером с id 100.

Поля в результирующей таблице: order_id, time

Пояснение:

Обратите внимание, что в исходной таблице есть записи не только со временем доставки, но и временем принятия заказа.

Решение:

    SELECT
        order_id, 
        time
    FROM courier_actions
    WHERE 
        courier_id = 100 
        AND action = 'deliver_order'
    ORDER BY
        time DESC
    LIMIT 10

# Задание 13
Из таблицы user_actions получите id всех заказов, сделанных пользователями сервиса в августе 2022 года.

Результат отсортируйте по возрастанию id заказа.

Поле в результирующей таблице: order_id

Пояснение:

Обратите внимание, что в исходной таблице есть записи не только со временем оформления, но и временем отмены заказа.

В этой задаче вам может пригодиться функция DATE_PART. Мы рассматривали её на прошлом уроке в этом задании.

Решение:

    SELECT
        order_id
    FROM user_actions
    WHERE
        action = 'create_order'
        AND time BETWEEN '2022-08-01 00:00:00' AND '2022-08-31 23:59:59'
    ORDER BY
        order_id

## Задание 14
Из таблицы couriers отберите id всех курьеров, родившихся в период с 1990 по 1995 год включительно.

Результат отсортируйте по возрастанию id курьера.

Поле в результирующей таблице: courier_id

Пояснение:

В этой задаче вам снова может пригодиться функция DATE_PART.

Решение:

    SELECT
        courier_id
    FROM couriers
    WHERE
        DATE_PART('year', DATE(birth_date)) BETWEEN '1990' AND '1995'
    ORDER BY
        courier_id ASC

## Задание 15
Из таблицы user_actions получите информацию о всех отменах заказов, которые пользователи совершали в течение августа 2022 года по средам с 12:00 до 15:59.

Результат отсортируйте по убыванию id отменённых заказов.

Поля в результирующей таблице: user_id, order_id, action, time

Пояснение:

Будьте внимательны при работе с датами и временем.

Для решения задачи вам может пригодиться функция DATE_PART. Для получения дня недели можно указать аргумент 'dow' («day of week»):

    SELECT DATE_PART('dow', DATE '2022-12-31')
    
    Результат:
    6.00

В PostgreSQL дни недели считаются с воскресенья (0) до субботы (6).

Решение:
    
    SELECT
        user_id, 
        order_id, 
        action, 
        time
    FROM user_actions
    WHERE
        DATE_PART('dow', DATE(time)) = 3 
        AND time BETWEEN '2022-08-01' AND '2022-08-31 23:59:59'
        AND DATE_PART('hour', time) BETWEEN '12' AND '15'
        AND action = 'cancel_order'
    ORDER BY
        order_id DESC

## Задание 16
Как и в задаче из прошлого урока, вычислите НДС каждого товара в таблице products и рассчитайте цену без учёта НДС. Однако теперь примите во внимание, что для товаров из списка налог составляет 10%. Для остальных товаров НДС тот же — 20%.

Выведите всю информацию о товарах, включая сумму налога и цену без его учёта. Колонки с суммой налога и ценой без НДС назовите соответственно tax и price_before_tax. Округлите значения в этих колонках до двух знаков после запятой.

Результат отсортируйте сначала по убыванию цены товара без учёта НДС, затем по возрастанию id товара.

Поля в результирующей таблице: product_id, name, price, tax, price_before_tax

Пояснение:

Порядок расчёта налога тот же, что и в задании из прошлого урока.

Для решения задачи вам могут пригодиться конструкция CASE и оператор IN. Конструкцию CASE мы рассматривали в этом задании.

Решение:

    SELECT
        ROUND(CASE 
            WHEN name IN('сахар', 'сухарики', 'сушки', 'семечки', 
                'масло льняное', 'виноград', 'масло оливковое', 
                'арбуз', 'батон', 'йогурт', 'сливки', 'гречка', 
                'овсянка', 'макароны', 'баранина', 'апельсины', 
                'бублики', 'хлеб', 'горох', 'сметана', 'рыба копченая', 
                'мука', 'шпроты', 'сосиски', 'свинина', 'рис', 
                'масло кунжутное', 'сгущенка', 'ананас', 'говядина', 
                'соль', 'рыба вяленая', 'масло подсолнечное', 'яблоки', 
                'груши', 'лепешка', 'молоко', 'курица', 'лаваш', 'вафли', 'мандарины') THEN price / 1.1 * 0.1
            ELSE price / 1.2 * 0.2
        END, 2) AS tax,
        product_id, 
        name, 
        price, 
        ROUND(CASE 
            WHEN name IN('сахар', 'сухарики', 'сушки', 'семечки', 
                'масло льняное', 'виноград', 'масло оливковое', 
                'арбуз', 'батон', 'йогурт', 'сливки', 'гречка', 
                'овсянка', 'макароны', 'баранина', 'апельсины', 
                'бублики', 'хлеб', 'горох', 'сметана', 'рыба копченая', 
                'мука', 'шпроты', 'сосиски', 'свинина', 'рис', 
                'масло кунжутное', 'сгущенка', 'ананас', 'говядина', 
                'соль', 'рыба вяленая', 'масло подсолнечное', 'яблоки', 
                'груши', 'лепешка', 'молоко', 'курица', 'лаваш', 'вафли', 'мандарины') THEN price / 1.1
            ELSE price / 1.2
        END, 2) AS price_before_tax
    FROM products
    ORDER BY
        price_before_tax DESC,
        product_id ASC

## Подведем итоги
В этом уроке мы:

Научились фильтровать данные и применять логические выражения в блоке WHERE.
Выяснили, что фильтрацию можно делать сразу по расчётным полям с применением функций к колонкам.
Разобрались, как задавать шаблоны для текстовых значений с помощью оператора LIKE.
Познакомились с операторами IN и BETWEEN.
Узнали ещё больше о NULL значениях и научились отфильтровывать их с помощью IS NULL.
Поработали с датами и временем и научились задавать диапазоны значений.
Совместили новые знания с информацией из прошлого урока и решили большую задачу на CASE.
Известные нам на текущий момент ключевые слова и порядок их написания в запросе:

    SELECT     -- перечисление полей результирующей таблицы
    FROM       -- указание источника данных
    WHERE      -- фильтрация данных
    ORDER BY   -- сортировка результирующей таблицы
    LIMIT      -- ограничение количества выводимых записей
