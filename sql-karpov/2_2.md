# Анализ продуктовых метрик. Экономика продукта

## Задание 1
Начнём с выручки — наиболее общего показателя, который покажет, какой доход приносит наш сервис.

Для каждого дня в таблице orders рассчитайте следующие показатели:

1. Выручку, полученную в этот день.
2. Суммарную выручку на текущий день.
3. Прирост выручки, полученной в этот день, относительно значения выручки за предыдущий день.

Колонки с показателями назовите соответственно revenue, total_revenue, revenue_change. Колонку с датами назовите date.

Прирост выручки рассчитайте в процентах и округлите значения до двух знаков после запятой.

Результат должен быть отсортирован по возрастанию даты.

Поля в результирующей таблице: date, revenue, total_revenue, revenue_change

**Пояснение:**

Будем считать, что оплата за заказ поступает сразу же после его оформления, т.е. случаи, когда заказ был оформлен в один день, а оплата получена на следующий, возникнуть не могут.

Суммарная выручка на текущий день — это результат сложения выручки, полученной в текущий день, со значениями аналогичного показателя всех предыдущих дней.

При расчёте выручки помните, что не все заказы были оплачены — некоторые были отменены пользователями.

Не забывайте при делении заранее приводить значения к нужному типу данных. Пропущенные значения прироста для самой первой даты не заполняйте — просто оставьте поля в этой строке пустыми.

**Подсказка на случай, если совсем не получается**

Для решения задачи вам потребуется информация о заказах из таблицы orders и ценах на товары из таблицы products. Чтобы посчитать выручку для каждого дня, сначала необходимо посчитать стоимость каждого заказа. Это можно сделать, сложив цены входящих в заказ товаров. Чтобы правильно присоединить данные о ценах на товары, списки с содержимым заказов нужно предварительно расширить с помощью функции unnest. После того как для каждого дня будет посчитана суммарная стоимость всех заказов (выручка), с помощью оконных функций можно посчитать сумму нарастающим итогом (общую выручку) и прирост выручки (разницу между выручкой в текущий день и выручкой в предыдущий день, делённую на выручку в предыдущий день).

После того как составите запрос, попробуйте визуализировать результаты и постройте графики, отражающие динамику рассчитанных показателей.

### Решение:

Вариант 1

    SELECT
      t2.date,
      t2.revenue,
      SUM(t2.revenue) OVER(
        ORDER BY
          t2.date
      ) AS total_revenue,
      ROUND(
        (
          t2.revenue :: DECIMAL / LAG(t2.revenue, 1) OVER(
            ORDER BY
              t2.date
          ) - 1
        ) * 100,
        2
      ) AS revenue_change
    FROM
      (
        SELECT
          t1.date,
          SUM(p.price) AS revenue
        FROM
          (
            SELECT
              creation_time :: DATE AS date,
              UNNEST(product_ids) AS product_id
            FROM
              orders
            WHERE
              order_id NOT IN (
                SELECT
                  order_id
                FROM
                  user_actions
                WHERE
                  action = 'cancel_order'
              )
          ) t1
          LEFT JOIN products p ON p.product_id = t1.product_id
        GROUP BY
          t1.date
      ) t2
    ORDER BY
      t2.date

Вариант 2

    SELECT
      date,
      revenue,
      sum(revenue) OVER (
        ORDER BY
          date
      ) as total_revenue,
      round(
        100 * (
          revenue - lag(revenue, 1) OVER (
            ORDER BY
              date
          )
        ) :: decimal / lag(revenue, 1) OVER (
          ORDER BY
            date
        ),
        2
      ) as revenue_change
    FROM
      (
        SELECT
          creation_time :: date as date,
          sum(price) as revenue
        FROM
          (
            SELECT
              creation_time,
              unnest(product_ids) as product_id
            FROM
              orders
            WHERE
              order_id not in (
                SELECT
                  order_id
                FROM
                  user_actions
                WHERE
                  action = 'cancel_order'
              )
          ) t1
          LEFT JOIN products using (product_id)
        GROUP BY
          date
      ) t2

#### Замечание
Вариант запроса №2 от сервиса karpov, предлагается как верное решение. Его можно сократить, избыточность оконных функции стр. 10, достаточно сделать (revenue / пред. revenue - 1) * 100

### Визуализация

![визуализация 2_1_5](./img/2_2_1_vis.jpg)

Проанализируйте построенные графики и попробуйте ответить на следующие вопросы:

1. В какие дни наблюдалось заметное снижение ежедневной выручки? 
2. С чем это могло быть связано? (чтобы установить причину падения выручки, можете сопоставить текущие графики с графиками на дашборде из прошлого урока)
