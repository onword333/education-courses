# Оконные функции

Подробнее об оконных функциях можно почитать [здесь](https://www.postgresqltutorial.com/postgresql-window-function/).

Также рекомендуем к прочтению [статью на Хабре](https://habr.com/ru/post/268983/).

А ещё в нашем Telegram-канале есть небольшая [шпаргалка по работе с оконными функциями](https://t.me/KarpovCourses/998).

## Задание 1

Примените оконные функции к таблице products и с помощью ранжирующих функций упорядочьте все товары по цене — от самых дорогих к самым дешёвым. Добавьте в таблицу следующие колонки:

- Колонку product_number с порядковым номером товара (функция ROW_NUMBER).
- Колонку product_rank с рангом товара с пропусками рангов (функция RANK).
- Колонку product_dense_rank с рангом товара без пропусков рангов (функция DENSE_RANK).

Не забывайте указывать в окне сортировку записей — без неё ранжирующие функции могут давать некорректный результат, если таблица заранее не отсортирована. Деление на партиции внутри окна сейчас не требуется. Сортировать записи в результирующей таблице тоже не нужно.

Поля в результирующей таблице: product_id, name, price, product_number, product_rank, product_dense_rank

После того как решите задачу, посмотрите, что в итоге получилось, и проанализируйте результат.

Решение:

    SELECT
      p.product_id,
      p.name,
      p.price,
      ROW_NUMBER() OVER (
        ORDER BY
          p.price DESC
      ) AS product_number,
      RANK() OVER (
        ORDER BY
          p.price DESC
      ) AS product_rank,
      DENSE_RANK() OVER(
        ORDER BY
          p.price DESC
      ) AS product_dense_rank
    FROM
      products p

## Задание 2

Примените оконную функцию к таблице products и с помощью агрегирующей функции в отдельной колонке для каждой записи проставьте цену самого дорогого товара. Колонку с этим значением назовите max_price. Затем для каждого товара посчитайте долю его цены в стоимости самого дорогого товара — просто поделите одну колонку на другую. Полученные доли округлите до двух знаков после запятой. Колонку с долями назовите share_of_max.

Выведите всю информацию о товарах, включая значения в новых колонках. Результат отсортируйте сначала по убыванию цены товара, затем по возрастанию id товара.

Поля в результирующей таблице: product_id, name, price, max_price, share_of_max

Пояснение:

В этой задаче окном выступает вся таблица. Сортировку внутри окна указывать не нужно.

С результатом агрегации по окну можно проводить арифметические и логические операции. Также к нему можно применять и другие функции — например, округление, как в этой задаче.

Решение:

    SELECT
      p.product_id,
      p.name,
      p.price,
      MAX(p.price) OVER () AS max_price,
      ROUND(p.price / MAX(p.price) OVER (), 2) AS share_of_max
    FROM
      products p
    ORDER BY
      p.price DESC,
      p.product_id ASC
